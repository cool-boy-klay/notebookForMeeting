Redis的AOF持久化

特点：

通过保存Redis服务器所执行的写命令来记录数据库状态

与RDF的区别是RDF保存数据库的键值对

持久化实现（三个步骤）

1.追加

服务器执行完一个命令之后会将命令写入到缓冲区aof_buf末尾

2.文件写入

服务器每执行完一个事件都会判断是否需要将aof_buf的内容写入保存到AOF文件里

不同appendfsync

always

每次都将aof缓冲区内容写入到AOF文件

everysec

距离上次AOF写入超过1秒就写入到AOF中

no

3.文件同步

AOF文件载入和还原



AOF重写

通过创建一个新的AOF文件替代现在的AOF文件，并取代一些浪费空间的命令

实现

通过读取服务器当前的数据库状态实现的

从数据库中读取键现在的值，并用一条命令去记录键值对，替代之前的多条命令

后台重写

因为重写过程需要大量的写入操作，IO操作会比较消耗时间，所以Redis创建一个子进程实现重写

优点：

父进程可以继续处理命令请求

子进程带有服务器的进程的副本可以避免使用锁的情况下保证数据的安全性

重写期间的新命令写入会导致重写后的数据库状态与AOF保存的数据库状态不一致

解决办法

AOF重写缓冲区

在AOF进行重写后开始使用

重写期间Redis每执行完一个写命令会同时将写命令发送给AOF缓冲区和AOF重写缓冲区

在重写完毕之后，子进程会发送信号给父进程

父进程会把重写缓冲区的所有内容写入到AOF文件中并对新的AOF文件原子地覆盖现在的AOF文件
